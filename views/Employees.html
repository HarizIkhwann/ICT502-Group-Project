<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HR System - Employee Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
  </head>

  <body class="bg-gray-100 font-sans">
    <div
      class="md:hidden bg-slate-900 text-white p-4 flex justify-between items-center shadow-md"
    >
      <h2 class="text-xl font-bold text-blue-400 italic">HR_DB</h2>
      <button onclick="toggleSidebar()" class="text-2xl focus:outline-none">
        <i class="fas fa-bars"></i>
      </button>
    </div>

    <div
      id="sidebar-overlay"
      onclick="toggleSidebar()"
      class="fixed inset-0 bg-black/50 z-40 hidden transition-opacity"
    ></div>

    <div class="flex min-h-screen">
      <!-- Sidebar injected here -->
      <div id="sidebar-container" class="md:w-64 bg-slate-900"></div>

      <main class="flex-1 p-4 md:p-8">
        <div class="max-w-7xl mx-auto">
          <div
            class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4"
          >
            <div>
              <h1 class="text-3xl font-bold text-gray-800">
                Employee Directory
              </h1>
              <p class="text-gray-500 text-sm">
                Managing staff records, contact details, and age compliance
              </p>
            </div>
            <button
              onclick="toggleModal(true)"
              class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg shadow-lg flex items-center justify-center font-semibold transition"
            >
              <i class="fas fa-plus-circle mr-2"></i> Add New Employee
            </button>
          </div>

          <div class="space-y-12">
            <section>
              <h2
                class="text-xl font-bold text-gray-700 mb-4 flex items-center"
              >
                <span class="w-2 h-6 bg-blue-600 rounded mr-2"></span> Permanent
                Staff
              </h2>
              <div
                class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-x-auto"
              >
                <table class="w-full text-left min-w-[1100px]">
                  <thead
                    class="bg-gray-50 border-b border-gray-200 text-gray-600 text-xs uppercase font-bold tracking-wider"
                  >
                    <tr>
                      <th class="px-6 py-4">Employee</th>
                      <th class="px-6 py-4">Contact Info</th>
                      <th class="px-6 py-4">Address</th>
                      <th class="px-6 py-4">Birth Date</th>
                      <th class="px-6 py-4">Hire Date</th>
                      <th class="px-6 py-4">Post & Dept</th>
                      <th class="px-6 py-4 text-center">Actions</th>
                    </tr>
                  </thead>
                  <tbody
                    id="permanent-table-body"
                    class="divide-y divide-gray-100 text-sm"
                  >
                    <tr class="hover:bg-gray-50 transition">
                      <td class="px-6 py-4">
                        <div class="flex items-center">
                          <div
                            class="w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold mr-3"
                          >
                            JD
                          </div>
                          <div>
                            <div class="font-bold text-gray-900">John Doe</div>
                            <div
                              class="text-xs text-gray-500 tracking-widest uppercase"
                            >
                              EMP-101
                            </div>
                          </div>
                        </div>
                      </td>
                      <td class="px-6 py-4">
                        <div class="text-gray-900 font-medium">
                          john.doe@email.com
                        </div>
                        <div class="text-gray-500 text-xs">
                          +1 (555) 123-4567
                        </div>
                      </td>
                      <td class="px-6 py-4 text-gray-600 text-sm">
                        123 Main Street, New York, NY
                      </td>

                      <td class="px-6 py-4 text-gray-600 font-mono italic">
                        1992-04-15
                      </td>
                      <td class="px-6 py-4 text-gray-600 font-mono">
                        2023-01-10
                      </td>
                      <td class="px-6 py-4">
                        <div class="text-gray-900 font-medium">Post</div>
                        <div class="text-gray-900 font-medium">Dept</div>
                        <div class="text-gray-900 font-medium">Manager</div>
                      </td>
                      <td class="px-6 py-4 text-center space-x-3 text-lg">
                        <button class="text-gray-400 hover:text-blue-600">
                          <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-gray-400 hover:text-red-600">
                          <i class="fas fa-trash"></i>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </section>

            <section>
              <h2
                class="text-xl font-bold text-gray-700 mb-4 flex items-center"
              >
                <span class="w-2 h-6 bg-orange-500 rounded mr-2"></span>
                Contract Staff
              </h2>
              <div
                class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-x-auto"
              >
                <table class="w-full text-left min-w-[1100px]">
                  <thead
                    class="bg-gray-50 border-b border-gray-200 text-gray-600 text-xs uppercase font-bold tracking-wider"
                  >
                    <tr>
                      <th class="px-6 py-4">Employee</th>
                      <th class="px-6 py-4">Contact Info</th>
                      <th class="px-6 py-4">Address</th>
                      <th class="px-6 py-4">Birth Date</th>
                      <th class="px-6 py-4">Hire Date</th>
                      <th class="px-6 py-4">Post & Dept</th>
                      <th class="px-6 py-4 text-center">Actions</th>
                    </tr>
                  </thead>
                  <tbody
                    id="contract-table-body"
                    class="divide-y divide-gray-100 text-sm"
                  >
                    <tr class="hover:bg-gray-50 transition">
                      <td class="px-6 py-4">
                        <div class="flex items-center">
                          <div
                            class="w-10 h-10 rounded-full bg-orange-500 text-white flex items-center justify-center font-bold mr-3"
                          >
                            AS
                          </div>
                          <div>
                            <div class="font-bold text-gray-900">
                              Alice Smith
                            </div>
                            <div
                              class="text-xs text-gray-500 tracking-widest uppercase"
                            >
                              CON-405
                            </div>
                          </div>
                        </div>
                      </td>
                      <td class="px-6 py-4">
                        <div class="text-gray-900 font-medium">
                          alice.s@freelance.com
                        </div>
                        <div class="text-gray-500 text-xs">
                          +1 (555) 987-6543
                        </div>
                      </td>
                      <td class="px-6 py-4 text-gray-600 text-sm">
                        123 Main Street, New York, NY
                      </td>

                      <td class="px-6 py-4 text-gray-600 font-mono italic">
                        1995-11-22
                      </td>
                      <td class="px-6 py-4 text-gray-600 font-mono">
                        2024-05-01
                      </td>
                      <td class="px-6 py-4">
                        <div class="text-gray-900 font-medium">Post</div>
                        <div class="text-gray-900 font-medium">Dept</div>
                        <div class="text-gray-900 font-medium">Manager</div>
                      </td>
                      <td class="px-6 py-4 text-center space-x-3 text-lg">
                        <button class="text-gray-400 hover:text-blue-600">
                          <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-gray-400 hover:text-red-600">
                          <i class="fas fa-trash"></i>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </section>
          </div>
        </div>
      </main>
    </div>

    <div
      id="add-modal"
      class="fixed inset-0 z-[60] flex items-center justify-center hidden p-4"
    >
      <div
        class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm"
        onclick="toggleModal(false)"
      ></div>
      <div
        class="relative bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden"
      >
        <div
          class="bg-gray-50 px-6 py-4 border-b flex justify-between items-center"
        >
          <h3 class="text-xl font-bold text-gray-800">Registration Form</h3>
          <button
            onclick="toggleModal(false)"
            class="text-gray-400 hover:text-gray-600"
          >
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>

        <form id="employee-form" class="p-6 max-h-[80vh] overflow-y-auto">
          <div
            class="mb-6 p-4 bg-gray-50 rounded-xl border border-gray-200 grid grid-cols-2 gap-4"
          >
            <div class="col-span-2 md:col-span-1">
              <label
                class="block text-xs font-bold text-gray-500 uppercase mb-1"
                >Employment Type</label
              >
              <select
                id="emp_type"
                class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
              >
                <option value="permanent">Permanent Staff</option>
                <option value="contract">Contract Staff</option>
              </select>
            </div>
            <div class="col-span-2 md:col-span-1">
              <label
                class="block text-xs font-bold text-gray-500 uppercase mb-1"
                >Phone Number</label
              >
              <input
                type="tel"
                id="emp_phone"
                placeholder="+1 (555) 000-0000"
                required
                class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
              />
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1"
                >First Name</label
              >
              <input
                type="text"
                id="first_name"
                required
                class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1"
                >Last Name</label
              >
              <input
                type="text"
                id="last_name"
                required
                class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1"
                >Position ID</label
              >
              <input
                type="number"
                id="pos_id"
                required
                class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1"
                >Department ID</label
              >
              <input
                type="number"
                id="dept_id"
                required
                class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
          </div>

          <div class="mb-4">
            <label class="block text-sm font-semibold text-gray-700 mb-1"
              >Email Address</label
            >
            <input
              type="email"
              id="emp_email"
              required
              class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          <div class="mb-4">
            <label class="block text-sm font-semibold text-gray-700 mb-1"
              >Address</label
            >
            <textarea
              id="emp_address"
              rows="2"
              required
              class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Street, City, State, ZIP"
            ></textarea>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1"
                >Date of Birth</label
              >
              <input
                type="date"
                id="dob_input"
                required
                class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1"
                >Hire Date</label
              >
              <input
                type="date"
                id="hire_date"
                required
                class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
          </div>

          <div class="flex justify-end gap-3 pt-4 border-t">
            <button
              type="button"
              onclick="toggleModal(false)"
              class="px-6 py-2 text-gray-600 font-medium"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-md"
            >
              Register
            </button>
          </div>
        </form>
      </div>
    </div>

    <div
      id="notification"
      class="fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg hidden z-[70] transition-all"
    ></div>

    <script>
      fetch("sidebar.html")
        .then((res) => res.text())
        .then((html) => {
          document.getElementById("sidebar-container").innerHTML = html;
        });
    </script>
    <script>
      const API_BASE = "http://localhost/ICT502%20Group%20Project/api";
      let editingEmployeeId = null;

      function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("sidebar-overlay");
        sidebar?.classList.toggle("-translate-x-full");
        overlay?.classList.toggle("hidden");
      }

      // Restrict DOB to 18+
      const dobInput = document.getElementById("dob_input");
      const today = new Date();
      const maxDate = new Date(
        today.getFullYear() - 18,
        today.getMonth(),
        today.getDate(),
      )
        .toISOString()
        .split("T")[0];
      dobInput.setAttribute("max", maxDate);

      function toggleModal(show, employeeData = null) {
        const modal = document.getElementById("add-modal");
        const form = document.getElementById("employee-form");

        if (show) {
          if (employeeData) {
            editingEmployeeId = employeeData.EMPLOYEE_ID;
            document.getElementById("emp_type").value =
              employeeData.EMPLOYEE_TYPE?.toLowerCase() || "permanent";
            document.getElementById("first_name").value =
              employeeData.FIRST_NAME;
            document.getElementById("last_name").value = employeeData.LAST_NAME;
            document.getElementById("emp_email").value = employeeData.EMAIL;
            document.getElementById("emp_phone").value =
              employeeData.PHONE_NUMBER;
            document.getElementById("emp_address").value = employeeData.ADDRESS;
            document.getElementById("dob_input").value =
              employeeData.DATE_OF_BIRTH?.split("T")[0] || "";
            document.getElementById("hire_date").value =
              employeeData.HIRE_DATE?.split("T")[0] || "";
            document.getElementById("pos_id").value = employeeData.POSITION_ID;
            document.getElementById("dept_id").value =
              employeeData.DEPARTMENT_ID;
            modal.querySelector("h3").textContent = "Edit Employee";
          } else {
            editingEmployeeId = null;
            form.reset();
            modal.querySelector("h3").textContent = "Registration Form";
          }
          modal.classList.remove("hidden");
        } else {
          modal.classList.add("hidden");
        }
      }

      function showNotification(message, type = "success") {
        const notification = document.getElementById("notification");
        notification.textContent = message;
        notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-[70] transition-all ${
          type === "success"
            ? "bg-green-500 text-white"
            : "bg-red-500 text-white"
        }`;
        notification.classList.remove("hidden");
        setTimeout(() => notification.classList.add("hidden"), 3000);
      }

      async function loadEmployees() {
        try {
          console.log(
            "Loading employees from:",
            `${API_BASE}/employees/list.php`,
          );
          const response = await fetch(`${API_BASE}/employees/list.php`);
          console.log("Response status:", response.status);
          const result = await response.json();
          console.log("API Result:", result);

          if (result.success) {
            displayEmployees(result.data);
          } else {
            showNotification(
              "Error loading employees: " + result.message,
              "error",
            );
          }
        } catch (error) {
          showNotification("Failed to load employees", "error");
          console.error("Error loading employees:", error);
        }
      }

      function displayEmployees(employees) {
        const permanentBody = document.getElementById("permanent-table-body");
        const contractBody = document.getElementById("contract-table-body");
        permanentBody.innerHTML = "";
        contractBody.innerHTML = "";

        if (!employees || employees.length === 0) {
          permanentBody.innerHTML =
            '<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500">No permanent employees found</td></tr>';
          contractBody.innerHTML =
            '<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500">No contract employees found</td></tr>';
          return;
        }

        const permanent = employees.filter(
          (e) => e.EMPLOYEE_TYPE === "PERMANENT",
        );
        const contract = employees.filter(
          (e) => e.EMPLOYEE_TYPE === "CONTRACT",
        );

        if (permanent.length === 0) {
          permanentBody.innerHTML =
            '<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500">No permanent employees found</td></tr>';
        } else {
          permanent.forEach((emp) => {
            permanentBody.appendChild(createEmployeeRow(emp, "permanent"));
          });
        }

        if (contract.length === 0) {
          contractBody.innerHTML =
            '<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500">No contract employees found</td></tr>';
        } else {
          contract.forEach((emp) => {
            contractBody.appendChild(createEmployeeRow(emp, "contract"));
          });
        }
      }

      function createEmployeeRow(emp, type) {
        const row = document.createElement("tr");
        row.className = "hover:bg-gray-50 transition";

        const initials =
          (emp.FIRST_NAME?.[0] || "") + (emp.LAST_NAME?.[0] || "");
        const colorClass =
          type === "permanent" ? "bg-blue-500" : "bg-orange-500";

        row.innerHTML = `
                <td class="px-6 py-4">
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full ${colorClass} text-white flex items-center justify-center font-bold mr-3">
                            ${initials}
                        </div>
                        <div>
                            <div class="font-bold text-gray-900">${emp.FIRST_NAME} ${emp.LAST_NAME}</div>
                            <div class="text-xs text-gray-500 tracking-widest uppercase">ID: ${emp.EMPLOYEE_ID}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4">
                    <div class="text-gray-900 font-medium">${emp.EMAIL}</div>
                    <div class="text-gray-500 text-xs">${emp.PHONE_NUMBER}</div>
                </td>
                <td class="px-6 py-4 text-gray-600 text-sm">
                    ${emp.ADDRESS}
                </td>
                <td class="px-6 py-4 text-gray-600 font-mono italic">${emp.DATE_OF_BIRTH?.split("T")[0] || "N/A"}</td>
                <td class="px-6 py-4 text-gray-600 font-mono">${emp.HIRE_DATE?.split("T")[0] || "N/A"}</td>
                <td class="px-6 py-4">
                    <div class="text-gray-700 font-medium">Pos: ${emp.POSITION_ID || "-"}</div>
                    <div class="text-gray-700 font-medium">Dept: ${emp.DEPARTMENT_ID || "-"}</div>
                </td>
                <td class="px-6 py-4 text-center space-x-3 text-lg">
                    <button class="text-gray-400 hover:text-blue-600 edit-btn"><i class="fas fa-edit"></i></button>
                    <button class="text-gray-400 hover:text-red-600 delete-btn"><i class="fas fa-trash"></i></button>
                </td>
            `;

        row
          .querySelector(".edit-btn")
          .addEventListener("click", () => editEmployee(emp));
        row
          .querySelector(".delete-btn")
          .addEventListener("click", () => deleteEmployee(emp.EMPLOYEE_ID));

        return row;
      }

      function editEmployee(emp) {
        toggleModal(true, emp);
      }

      async function deleteEmployee(id) {
        if (!confirm("Are you sure you want to delete this employee?")) return;

        try {
          const response = await fetch(`${API_BASE}/employees/delete.php`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ employee_id: id }),
          });

          const result = await response.json();

          if (result.success) {
            showNotification("Employee deleted successfully", "success");
            loadEmployees();
          } else {
            showNotification("Error: " + result.message, "error");
          }
        } catch (error) {
          showNotification("Failed to delete employee", "error");
          console.error(error);
        }
      }

      document
        .getElementById("employee-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const formData = {
            first_name: document.getElementById("first_name").value,
            last_name: document.getElementById("last_name").value,
            email: document.getElementById("emp_email").value,
            phone_number: document.getElementById("emp_phone").value,
            address: document.getElementById("emp_address").value,
            date_of_birth: document.getElementById("dob_input").value,
            hire_date: document.getElementById("hire_date").value,
            position_id: parseInt(document.getElementById("pos_id").value),
            department_id: parseInt(document.getElementById("dept_id").value),
            employee_type: document
              .getElementById("emp_type")
              .value.toUpperCase(),
          };

          try {
            let response;
            if (editingEmployeeId) {
              formData.employee_id = editingEmployeeId;
              response = await fetch(`${API_BASE}/employees/update.php`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(formData),
              });
            } else {
              response = await fetch(`${API_BASE}/employees/create.php`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(formData),
              });
            }

            const result = await response.json();

            if (result.success) {
              showNotification(
                editingEmployeeId
                  ? "Employee updated successfully"
                  : "Employee created successfully",
                "success",
              );
              toggleModal(false);
              loadEmployees();
            } else {
              showNotification("Error: " + result.message, "error");
            }
          } catch (error) {
            showNotification("Failed to save employee", "error");
            console.error(error);
          }
        });

      document.addEventListener("DOMContentLoaded", loadEmployees);
    </script>
  </body>
</html>
