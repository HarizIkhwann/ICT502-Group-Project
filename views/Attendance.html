<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HR System - Attendance Tracking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
  </head>

  <body class="bg-gray-100 font-sans">
    <div
      class="md:hidden bg-slate-900 text-white p-4 flex justify-between items-center shadow-md"
    >
      <h2 class="text-xl font-bold text-blue-400 italic">HR_DB</h2>
      <button onclick="toggleSidebar()" class="text-2xl focus:outline-none">
        <i class="fas fa-bars"></i>
      </button>
    </div>

    <div
      id="sidebar-overlay"
      onclick="toggleSidebar()"
      class="fixed inset-0 bg-black/50 z-40 hidden transition-opacity"
    ></div>

    <div class="flex min-h-screen">
      <div id="sidebar-container" class="md:w-64 bg-slate-900"></div>

      <main class="flex-1 p-4 md:p-8">
        <div class="max-w-7xl mx-auto">
          <div
            class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4"
          >
            <div>
              <h1 class="text-3xl font-bold text-gray-800">
                Attendance Records
              </h1>
              <p class="text-gray-500 text-sm">
                Track employee check-ins, check-outs, and work hours
              </p>
            </div>
            <button
              onclick="toggleModal(true)"
              class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg shadow-lg flex items-center justify-center font-semibold transition"
            >
              <i class="fas fa-plus-circle mr-2"></i> Record Attendance
            </button>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div
              class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 flex items-center"
            >
              <div
                class="w-12 h-12 bg-green-100 text-green-600 rounded-full flex items-center justify-center mr-4"
              >
                <i class="fas fa-user-check text-xl"></i>
              </div>
              <div>
                <p
                  class="text-sm text-gray-500 font-medium uppercase tracking-wider"
                >
                  Present Today
                </p>
                <h2 id="present-count" class="text-2xl font-bold text-gray-900">
                  0
                </h2>
              </div>
            </div>
            <div
              class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 flex items-center"
            >
              <div
                class="w-12 h-12 bg-red-100 text-red-600 rounded-full flex items-center justify-center mr-4"
              >
                <i class="fas fa-user-times text-xl"></i>
              </div>
              <div>
                <p
                  class="text-sm text-gray-500 font-medium uppercase tracking-wider"
                >
                  Absent Today
                </p>
                <h2 id="absent-count" class="text-2xl font-bold text-gray-900">
                  0
                </h2>
              </div>
            </div>
            <div
              class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 flex items-center"
            >
              <div
                class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mr-4"
              >
                <i class="fas fa-clock text-xl"></i>
              </div>
              <div>
                <p
                  class="text-sm text-gray-500 font-medium uppercase tracking-wider"
                >
                  Avg Hours
                </p>
                <h2 id="avg-hours" class="text-2xl font-bold text-gray-900">
                  0.0
                </h2>
              </div>
            </div>
          </div>

          <div
            class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-x-auto"
          >
            <table class="w-full text-left min-w-[1100px]">
              <thead
                class="bg-gray-50 border-b border-gray-200 text-gray-600 text-xs uppercase font-bold tracking-wider"
              >
                <tr>
                  <th class="px-6 py-4">Attendance ID</th>
                  <th class="px-6 py-4">Employee</th>
                  <th class="px-6 py-4">Date</th>
                  <th class="px-6 py-4">Check-In</th>
                  <th class="px-6 py-4">Check-Out</th>
                  <th class="px-6 py-4">Hours Worked</th>
                  <th class="px-6 py-4">Status</th>
                  <th class="px-6 py-4 text-center">Actions</th>
                </tr>
              </thead>
              <tbody
                id="attendance-table-body"
                class="divide-y divide-gray-100 text-sm"
              ></tbody>
            </table>
          </div>
        </div>
      </main>
    </div>

    <div
      id="add-modal"
      class="fixed inset-0 z-[60] flex items-center justify-center hidden p-4"
    >
      <div
        class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm"
        onclick="toggleModal(false)"
      ></div>
      <div
        class="relative bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-200"
      >
        <div
          class="bg-gray-50 px-6 py-4 border-b flex justify-between items-center"
        >
          <h3 class="text-xl font-bold text-gray-800">Record Attendance</h3>
          <button
            onclick="toggleModal(false)"
            class="text-gray-400 hover:text-gray-600"
          >
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>

        <form id="attendance-form" class="p-6">
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1"
                >Employee ID</label
              >
              <input
                type="number"
                id="employee_id"
                placeholder="e.g. 1"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
              />
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1"
                >Attendance Date</label
              >
              <input
                type="date"
                id="attendance_date"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
              />
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1"
                >Check-In Time</label
              >
              <input
                type="time"
                id="check_in_time"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
              />
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1"
                >Check-Out Time
                <span class="text-gray-400 text-xs">(Optional)</span></label
              >
              <input
                type="time"
                id="check_out_time"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
              />
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1"
                >Status</label
              >
              <select
                id="status"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white"
              >
                <option value="Present">Present</option>
                <option value="Absent">Absent</option>
                <option value="Late">Late</option>
                <option value="Half-Day">Half-Day</option>
              </select>
            </div>
          </div>

          <div class="flex justify-end gap-3 pt-6 mt-6 border-t">
            <button
              type="button"
              onclick="toggleModal(false)"
              class="px-6 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-50 font-medium"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold"
            >
              Save Record
            </button>
          </div>
        </form>
      </div>
    </div>

    <div
      id="notification"
      class="fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg hidden z-[70] transition-all"
    ></div>

    <script>
      fetch("sidebar.html")
        .then((res) => res.text())
        .then((html) => {
          document.getElementById("sidebar-container").innerHTML = html;
        });
    </script>

    <script>
      const API_BASE = "http://localhost/ICT502%20Group%20Project/api";
      let editingAttendanceId = null;

      function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("sidebar-overlay");
        sidebar.classList.toggle("-translate-x-full");
        overlay.classList.toggle("hidden");
      }

      function toggleModal(show, attendanceData = null) {
        const modal = document.getElementById("add-modal");
        const form = document.getElementById("attendance-form");

        if (show) {
          if (attendanceData) {
            editingAttendanceId = attendanceData.ATTENDANCE_ID;
            document.getElementById("employee_id").value =
              attendanceData.EMPLOYEE_ID;
            document.getElementById("attendance_date").value =
              attendanceData.ATTENDANCE_DATE?.split("T")[0] || "";
            document.getElementById("check_in_time").value =
              attendanceData.CHECK_IN_TIME || "";
            document.getElementById("check_out_time").value =
              attendanceData.CHECK_OUT_TIME || "";
            document.getElementById("status").value =
              attendanceData.STATUS || "Present";
            modal.querySelector("h3").textContent = "Edit Attendance";
          } else {
            editingAttendanceId = null;
            form.reset();
            document.getElementById("attendance_date").valueAsDate = new Date();
            modal.querySelector("h3").textContent = "Record Attendance";
          }
          modal.classList.remove("hidden");
        } else {
          modal.classList.add("hidden");
        }
      }

      function showNotification(message, type = "success") {
        const notification = document.getElementById("notification");
        notification.textContent = message;
        notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-[70] transition-all ${
          type === "success"
            ? "bg-green-500 text-white"
            : "bg-red-500 text-white"
        }`;
        notification.classList.remove("hidden");
        setTimeout(() => notification.classList.add("hidden"), 3000);
      }

      async function loadAttendance() {
        try {
          const response = await fetch(`${API_BASE}/attendance/list.php`);
          const result = await response.json();

          if (result.success) {
            displayAttendance(result.data);
            updateStats(result.data);
          } else {
            showNotification(
              "Error loading attendance: " + result.message,
              "error",
            );
          }
        } catch (error) {
          showNotification("Failed to load attendance records", "error");
          console.error(error);
        }
      }

      function displayAttendance(records) {
        const tableBody = document.getElementById("attendance-table-body");
        tableBody.innerHTML = "";

        if (!records || records.length === 0) {
          tableBody.innerHTML =
            '<tr><td colspan="8" class="px-6 py-8 text-center text-gray-500">No attendance records found</td></tr>';
          return;
        }

        records.forEach((record) => {
          const row = document.createElement("tr");
          row.className = "hover:bg-gray-50 transition";

          const hoursWorked = calculateHours(
            record.CHECK_IN_TIME,
            record.CHECK_OUT_TIME,
          );
          const statusColor = getStatusColor(record.STATUS);

          row.innerHTML = `
                    <td class="px-6 py-4 font-mono text-blue-600 font-bold">${record.ATTENDANCE_ID}</td>
                    <td class="px-6 py-4 font-semibold text-gray-900">Employee #${record.EMPLOYEE_ID}</td>
                    <td class="px-6 py-4 text-gray-600">${record.ATTENDANCE_DATE?.split("T")[0] || "N/A"}</td>
                    <td class="px-6 py-4 text-gray-700 font-mono">${record.CHECK_IN_TIME || "-"}</td>
                    <td class="px-6 py-4 text-gray-700 font-mono">${record.CHECK_OUT_TIME || "-"}</td>
                    <td class="px-6 py-4 font-bold text-gray-900">${hoursWorked}</td>
                    <td class="px-6 py-4">
                        <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusColor}">
                            ${record.STATUS}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-center space-x-3 text-lg">
                        <button class="text-gray-400 hover:text-blue-600 edit-btn"><i class="fas fa-edit"></i></button>
                        <button class="text-gray-400 hover:text-red-600 delete-btn"><i class="fas fa-trash"></i></button>
                    </td>
                `;

          row
            .querySelector(".edit-btn")
            .addEventListener("click", () => editAttendance(record));
          row
            .querySelector(".delete-btn")
            .addEventListener("click", () =>
              deleteAttendance(record.ATTENDANCE_ID),
            );

          tableBody.appendChild(row);
        });
      }

      function calculateHours(checkIn, checkOut) {
        if (!checkIn || !checkOut) return "-";

        const [inH, inM] = checkIn.split(":").map(Number);
        const [outH, outM] = checkOut.split(":").map(Number);

        const totalMinutes = outH * 60 + outM - (inH * 60 + inM);
        const hours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;

        return `${hours}h ${minutes}m`;
      }

      function getStatusColor(status) {
        switch (status) {
          case "Present":
            return "bg-green-100 text-green-700";
          case "Absent":
            return "bg-red-100 text-red-700";
          case "Late":
            return "bg-yellow-100 text-yellow-700";
          case "Half-Day":
            return "bg-orange-100 text-orange-700";
          default:
            return "bg-gray-100 text-gray-700";
        }
      }

      function updateStats(records) {
        const today = new Date().toISOString().split("T")[0];
        const todayRecords = records.filter(
          (r) => r.ATTENDANCE_DATE?.split("T")[0] === today,
        );

        const presentCount = todayRecords.filter(
          (r) => r.STATUS === "Present" || r.STATUS === "Late",
        ).length;
        const absentCount = todayRecords.filter(
          (r) => r.STATUS === "Absent",
        ).length;

        let totalHours = 0;
        let validRecords = 0;
        records.forEach((record) => {
          if (record.CHECK_IN_TIME && record.CHECK_OUT_TIME) {
            const [inH, inM] = record.CHECK_IN_TIME.split(":").map(Number);
            const [outH, outM] = record.CHECK_OUT_TIME.split(":").map(Number);
            const hours = (outH * 60 + outM - (inH * 60 + inM)) / 60;
            if (hours > 0 && hours < 24) {
              totalHours += hours;
              validRecords++;
            }
          }
        });

        const avgHours =
          validRecords > 0 ? (totalHours / validRecords).toFixed(1) : "0.0";

        document.getElementById("present-count").textContent = presentCount;
        document.getElementById("absent-count").textContent = absentCount;
        document.getElementById("avg-hours").textContent = avgHours;
      }

      function editAttendance(record) {
        toggleModal(true, record);
      }

      async function deleteAttendance(id) {
        if (!confirm("Are you sure you want to delete this attendance record?"))
          return;

        try {
          const response = await fetch(`${API_BASE}/attendance/delete.php`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ attendance_id: id }),
          });

          const result = await response.json();

          if (result.success) {
            showNotification(
              "Attendance record deleted successfully",
              "success",
            );
            loadAttendance();
          } else {
            showNotification("Error: " + result.message, "error");
          }
        } catch (error) {
          showNotification("Failed to delete attendance record", "error");
          console.error(error);
        }
      }

      document
        .getElementById("attendance-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const formData = {
            employee_id: parseInt(document.getElementById("employee_id").value),
            attendance_date: document.getElementById("attendance_date").value,
            check_in_time: document.getElementById("check_in_time").value,
            check_out_time:
              document.getElementById("check_out_time").value || null,
            status: document.getElementById("status").value,
          };

          try {
            let response;
            if (editingAttendanceId) {
              formData.attendance_id = editingAttendanceId;
              response = await fetch(`${API_BASE}/attendance/update.php`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(formData),
              });
            } else {
              response = await fetch(`${API_BASE}/attendance/check-in.php`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(formData),
              });
            }

            const result = await response.json();

            if (result.success) {
              showNotification(
                editingAttendanceId
                  ? "Attendance updated successfully"
                  : "Attendance recorded successfully",
                "success",
              );
              toggleModal(false);
              loadAttendance();
            } else {
              showNotification("Error: " + result.message, "error");
            }
          } catch (error) {
            showNotification("Failed to save attendance record", "error");
            console.error(error);
          }
        });

      document.addEventListener("DOMContentLoaded", loadAttendance);
    </script>
  </body>
</html>
